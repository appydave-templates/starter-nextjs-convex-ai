# Story 1.11: React 19 + Next.js 15 with OpenNext Cloudflare Workers

## Status

Draft

## Story

**As a** developer,
**I want** to implement React 19 + Next.js 15 with OpenNext Cloudflare Workers deployment,
**so that** I can utilize modern React features (Actions, use() hook, optimistic UI) while maintaining Cloudflare infrastructure benefits and resolving static export limitations discovered in Story 1.10

## Acceptance Criteria

1. Next.js is upgraded to version 15.1.0 and React to version 19.0.0 with all type compatibility issues resolved
2. OpenNext Cloudflare adapter (`@opennextjs/cloudflare`) is installed and configured for Workers deployment
3. Wrangler configuration (`wrangler.toml`) is created with nodejs_compat flag and proper environment variable sync
4. Application deploys successfully to Cloudflare Workers with full SSR capability (no static export limitations)
5. Custom domain is migrated from Cloudflare Pages to Workers with SSL certificate working correctly
6. All existing authentication flows with BetterAuth continue to work without regression in Workers environment
7. Convex integration maintains full functionality including real-time subscriptions and server components
8. Log ingestion worker integration continues to work with main application deployed on Workers
9. CI/CD pipeline is updated to deploy via Wrangler CLI instead of Cloudflare Pages
10. All React 19 features are accessible and functional (Server Actions, use() hook, optimistic UI capabilities)

## Estimation & Planning

### Story Points

13

### Estimated Complexity

High

### Estimated Time

1-2 weeks

### Risk Level

Medium

Risk factors include:

- OpenNext adapter configuration complexity
- Custom domain migration from Pages to Workers
- CI/CD pipeline changes for Workers deployment
- React 19 ecosystem compatibility with third-party packages
- Workers runtime differences affecting application behavior

## Documentation Impact Assessment

**Architectural Patterns Established:**

- React 19 compatibility patterns with SSR-safe hook implementations
- OpenNext Cloudflare Workers deployment methodology
- Custom domain migration procedures for Cloudflare infrastructure
- Environment variable sync patterns across deployment platforms

**Documentation Files to Update:**

- `docs/architecture/tech-stack.md` - Update React 19, Next.js 15, add OpenNext adapter
- `docs/architecture/infrastructure-and-deployment.md` - Update deployment strategy from Pages to Workers
- `CLAUDE.md` - Update development commands and deployment procedures
- CI/CD documentation - Update pipeline for Workers deployment

**New Knowledge to Capture:**

- Complete React 19 + Next.js 15 + OpenNext migration methodology
- Workers vs Pages deployment considerations and trade-offs
- OpenNext adapter configuration patterns and troubleshooting
- Custom domain migration procedures within Cloudflare ecosystem

**Examples to Create:**

- Complete OpenNext Cloudflare Workers configuration
- React 19 Server Actions implementation examples
- SSR-safe hook patterns for Workers deployment
- Environment variable sync templates for Workers

## Tasks / Subtasks

- [ ] **React 19 + Next.js 15 Upgrade Implementation** (AC: 1)
  - [ ] Upgrade core dependencies: React 19.0.0, Next.js 15.1.0, @types packages
  - [ ] Install packages with --legacy-peer-deps to handle ecosystem compatibility
  - [ ] Apply React 19 compatibility patterns from Story 1.10 research
  - [ ] Update TypeScript configuration for React 19 type changes
  - [ ] Test local development environment with React 19 features

- [ ] **OpenNext Cloudflare Workers Setup** (AC: 2, 3)
  - [ ] Install @opennextjs/cloudflare adapter
  - [ ] Create wrangler.toml with nodejs_compat flag and compatibility date
  - [ ] Configure Next.js config for Workers deployment (remove static export)
  - [ ] Set up environment variable sync using existing scripts/sync-env.js system
  - [ ] Test local Workers development with `wrangler dev`

- [ ] **Workers Deployment and Domain Migration** (AC: 4, 5)
  - [ ] Deploy to workers.dev subdomain for initial testing
  - [ ] Validate all application functionality on Workers subdomain
  - [ ] Remove custom domain from Cloudflare Pages deployment
  - [ ] Add custom domain to Cloudflare Workers deployment
  - [ ] Verify SSL certificate provisioning and HTTPS functionality

- [ ] **Authentication and Convex Integration Validation** (AC: 6, 7)
  - [ ] Test BetterAuth integration with Workers deployment
  - [ ] Verify OAuth flows (GitHub, Google) work correctly
  - [ ] Test Convex real-time subscriptions and server components
  - [ ] Validate all authentication-protected routes and features

- [ ] **Log Worker Integration and Microservice Compatibility** (AC: 8)
  - [ ] Test browser → main app (Workers) → log ingestion worker flow
  - [ ] Verify Convex → log ingestion worker communication still works
  - [ ] Validate log ingestion worker API contracts remain unchanged
  - [ ] Test Redis storage and retrieval in log ingestion worker

- [ ] **CI/CD Pipeline Migration** (AC: 9)
  - [ ] Update GitHub Actions workflow to use Wrangler CLI deployment
  - [ ] Configure Cloudflare API tokens and secrets for automated deployment
  - [ ] Remove Cloudflare Pages deployment steps from pipeline
  - [ ] Test automated deployment from GitHub Actions to Workers

- [ ] **React 19 Features Implementation and Testing** (AC: 10)
  - [ ] Implement example Server Actions for form handling
  - [ ] Create use() hook examples for conditional data fetching
  - [ ] Test optimistic UI patterns with Convex mutations
  - [ ] Validate built-in metadata management functionality
  - [ ] Performance testing to confirm bundle size and runtime improvements

- [ ] **Documentation and Knowledge Capture**
  - [ ] Update all technical documentation with new deployment strategy
  - [ ] Create migration guide for template users
  - [ ] Document all configuration changes and environment setup
  - [ ] Update development workflow documentation for Workers deployment

## Dev Notes

### Previous Story Insights

**Story 1.10 Research Value**: Story 1.10 provided comprehensive React 19 + Next.js 15 compatibility research, identifying that application-level compatibility is fully achievable, but static export is blocked by Next.js framework bugs. All compatibility patterns, safe hooks, and migration methodology from 1.10 are directly applicable to this Workers deployment approach.

**Key Research Findings from 1.10**:

- React 19.0.0 + Next.js 15.0.4-canary.43 proven version combination
- Safe hook patterns (useAuthSafe, useSafeQuery, useSafeMutation) for SSR compatibility
- TypeScript compatibility solutions for React 19 type changes
- Comprehensive troubleshooting knowledge for common upgrade issues

### Data Models

**Convex Schema Compatibility** [Source: Story 1.10 validation]:

- All existing Convex schemas remain compatible with React 19 + Next.js 15
- BetterAuth user models and session management work with Workers deployment
- No data model changes required - Workers deployment maintains same backend integration

### API Specifications

**OpenNext Workers Requirements** [Source: comprehensive research]:

- **OpenNext Adapter**: `@opennextjs/cloudflare` provides full Node.js runtime support
- **Wrangler Configuration**: nodejs_compat flag required for Next.js compatibility
- **Environment Variables**: Existing sync system compatible with Workers secrets management
- **API Routes**: All Next.js API routes supported in Workers environment (no limitations)

### Component Specifications

**React 19 Component Patterns** [Source: Story 1.10 patterns library]:

- **Server Actions**: Direct form handling without manual useState/loading states
- **use() Hook**: Conditional hook usage for dynamic data fetching scenarios
- **Optimistic UI**: Built-in useOptimistic hook for immediate UI updates
- **SSR Safety**: Conditional rendering patterns for server/client boundary management

### File Locations

**Based on Project Structure** [Source: docs/architecture/source-tree.md]:

**Primary Configuration Files**:

- `apps/web/package.json` - React 19, Next.js 15, OpenNext dependencies
- `wrangler.toml` - New file for Workers deployment configuration
- `apps/web/next.config.js` - Updated for Workers deployment (remove static export)
- `.github/workflows/ci.yml` - Updated deployment pipeline for Wrangler CLI

**Implementation Files**:

- `apps/web/lib/convex-safe-hooks.ts` - SSR-safe hook wrappers (from 1.10 research)
- `apps/web/components/auth/auth-provider.tsx` - Enhanced with useAuthSafe patterns
- `apps/web/app/layout.tsx` - Conditional provider rendering for SSR compatibility

### Testing Requirements

**Based on Test Strategy** [Source: docs/testing/technical/test-strategy-and-standards.md]:

- **Unit Tests**: All existing tests must pass with React 19 + Workers deployment
- **Integration Tests**: Workers runtime compatibility with Convex + BetterAuth
- **E2E Tests**: Complete user flows including React 19 features on Workers
- **Deployment Tests**: CI pipeline validation for Workers deployment process
- **Microservice Tests**: Log ingestion worker communication with main app on Workers

### Technical Constraints

**Version Requirements** [Source: research + compatibility validation]:

- **React 19.0.0**: Stable release for production use
- **Next.js 15.1.0**: Latest with OpenNext compatibility
- **OpenNext @opennextjs/cloudflare**: Latest version for full feature support
- **Node.js Compatibility**: nodejs_compat flag required in wrangler.toml

**Deployment Requirements**:

- **Workers Configuration**: Compatibility date 2024-09-23 or later required
- **Domain Migration**: Direct cutover from Pages to Workers (PoC acceptable downtime)
- **Environment Variables**: Maintain existing `.env.source-of-truth.local` sync system
- **CI/CD**: Wrangler CLI authentication via Cloudflare API tokens

**Performance Considerations**:

- **Bundle Size**: React 19 provides smaller bundles than React 18
- **Edge Performance**: Workers deployment provides better global performance than Pages
- **Cold Start**: Workers have faster cold start times than traditional serverless

### Pattern Validation

**Established Patterns to Follow**:

- **Compatibility Patterns**: Apply all React 19 safe hook patterns from Story 1.10 research
- **Environment Sync**: Use existing `scripts/sync-env.js` system for Workers secrets
- **Authentication**: Preserve all BetterAuth integration patterns from Epic 1 stories
- **Microservice Communication**: Maintain log ingestion worker API contracts
- **CI/CD**: Follow established testing and deployment validation patterns

### Testing Standards

**Test File Locations** [Source: docs/testing/technical/test-strategy-and-standards.md]:

- **Migration Tests**: `tests/web/integration/react-19-workers-migration.test.ts`
- **Workers Deployment Tests**: Validate full functionality on Workers runtime
- **React 19 Feature Tests**: Server Actions, use() hook, optimistic UI validation
- **Authentication Tests**: BetterAuth + Workers compatibility validation

**Testing Frameworks**: Jest + React Testing Library (with React 19 support), Playwright for E2E
**Validation Strategy**: Comprehensive testing of Workers deployment + React 19 features

## Change Log

| Date       | Version | Description                                                       | Author             |
| ---------- | ------- | ----------------------------------------------------------------- | ------------------ |
| 2025-08-08 | 1.0     | Initial story creation for React 19 + OpenNext Workers deployment | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

_This section will be populated by the development agent during implementation_

### Debug Log References

_This section will be populated by the development agent during implementation_

### Completion Notes List

_This section will be populated by the development agent during implementation_

### File List

_This section will be populated by the development agent during implementation_

## QA Results

_This section will be populated by the QA agent after story completion_

### Pattern Compliance Review

_To be filled during QA review_

### Knowledge Capture

_To be filled during QA review_

### Velocity Data

_To be filled during QA review_
